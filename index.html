<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Monthly Art Vol.2 - Boiling Point: Emerging Artists & Spaces in Seoul</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- PageFlip -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/page-flip/dist/css/page-flip.min.css">
  <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>
  <!-- Panzoom -->
  <script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@4.6.0/dist/panzoom.min.js"></script>
  <style>
    :root{
      --bg:#0b0c10; --panel:#151821; --text:#e9eef6; --muted:#9aa3b2; --accent:#46b3ff; --paper-dark:#0e1117;
      --page-w:1240px; --page-h:1624px; --book-w:2480px; --content-w:2480px;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0d1017,#0b0c10);color:var(--text);font-family:system-ui,"Noto Sans KR",sans-serif}
    .app{display:grid;grid-template-rows:auto 1fr auto;height:100%;gap:10px}
    .toolbar,.footer{background:#151821cc;backdrop-filter:blur(6px);padding:10px 12px;display:flex;align-items:center;gap:10px;border-block:1px solid #222938}
    .spacer{flex:1}
    .btn{border:1px solid #2a3143;background:#1a1f2c;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    .field{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3143;border-radius:10px;padding:6px 10px;background:#101522}
    .hint{color:var(--muted);font-size:13px}

    /* 뷰포트/줌 레이어 */
    #viewer{
      position:relative;display:grid;place-items:center;overflow:hidden;background:transparent;
      touch-action:none; /* Panzoom 전담 */
    }
    #zoomLayer{
      position:relative;width:fit-content;height:fit-content;
      transform-origin:0 0; cursor:grab; user-select:none; background:var(--paper-dark);
      touch-action:none; will-change:transform;
    }
    #zoomLayer.dragging{cursor:grabbing;}

    /* PageFlip 컨테이너 (고정 픽셀) */
    #flip{
      position:relative; width:var(--content-w); height:var(--page-h);
      transition:none; background:var(--paper-dark);
      /* hover/클릭/포인터를 완전히 차단해서 PageFlip의 hover 애니메이션 제거 */
      pointer-events:none;
    }
    #flip *{ pointer-events:none !important; }
    .stf__canvas, .stf_canvas, #flip canvas{ background:var(--paper-dark) !important; }

    input[type="number"]{width:70px;background:transparent;border:none;color:inherit;text-align:right;font-weight:700}
    #status{font-weight:600}

    /* 제목 박스 */
    .titleBox{
      min-width:0; max-width:clamp(160px, 45vw, 720px);
      display:flex; align-items:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-height:35px;
    }
    .titleText{
      font-weight:700; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size:clamp(12px,1.6vw,16px); line-height:1.1; min-width:0;
    }

    /* 모바일(좁은 폭) 상단 메뉴 간소화 */
    @media (max-width: 900px){
      .titleBox, #status, #pageGroup, .spacer { display:none !important; }
    }
    @media (max-width: 640px){
      .toolbar .btn, .toolbar .field { padding: 4px 8px; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="field titleBox"><span id="bookTitle" class="titleText">Boiling Point: Emerging Artists & Spaces in Korea</span></div>
    <div class="spacer"></div>
    <div id="status" class="hint">Loading…</div>

    <button id="prev" class="btn">◀ Prev</button>

    <div id="pageGroup" class="field">
      <span>Page</span>
      <input id="page" type="number" min="1" value="1">
      <span id="total">/ 0</span>
    </div>

    <button id="next" class="btn">Next ▶</button>

    <button id="fs" class="btn" title="전체화면">⛶ Full</button>
  </div>

  <div id="viewer">
    <div id="zoomLayer">
      <div id="flip"></div>
    </div>
  </div>

  <div class="footer" style="justify-content:space-between">
    <div class="hint">ⓒ Wolganmisool Publications, Inc. 2025 All Right Reserved.</div>
    <div class="hint"></div>
  </div>
</div>

<script>
  const DEFAULT_MANIFEST = "./manifest.json";
  const qp = new URLSearchParams(location.search);
  const manifestArg = qp.get("manifest") || DEFAULT_MANIFEST;

  const viewer = document.getElementById('viewer');
  const zoomLayer = document.getElementById('zoomLayer');
  const flipRoot = document.getElementById('flip');
  const bookTitleEl = document.getElementById('bookTitle');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const pageInput = document.getElementById('page');
  const totalEl = document.getElementById('total');
  const fsBtn = document.getElementById('fs');
  const statusEl = document.getElementById('status');

  let pageFlip = null;
  let currentPages = [];

  // Panzoom
  let pz = null;
  const MIN_SCALE = 0.25, MAX_SCALE = 4.0;

  // 페이지/레이아웃
  let PAGE_W = 1240, PAGE_H = 1624; // 첫 이미지로 자동 감지
  let BOOK_W = PAGE_W * 2;
  const MOBILE_BREAKPOINT = 900;
  let isSinglePageMode = false;     // true=단면, false=스프레드
  let CONTENT_W = BOOK_W;

  // 엣지 탭 내비
  const EDGE_TAP_ZONE = 0.22, TAP_MAX_DIST = 8, TAP_MAX_MS = 300;
  let tapStart = null;

  // ===== 유틸 =====
  function setStatus(msg){ statusEl.textContent = msg; }
  function naturalSort(a,b){ const c = new Intl.Collator(undefined,{numeric:true,sensitivity:'base'}); return c.compare(a,b); }
  function toAbs(urlLike, baseHref){ try { return new URL(urlLike, baseHref).href; } catch { return urlLike; } }
  function isTextInputFocused(){
    const ae = document.activeElement;
    return !!ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable);
  }

  function applyCSSVars(){
    const root = document.documentElement;
    root.style.setProperty('--page-w', PAGE_W + 'px');
    root.style.setProperty('--page-h', PAGE_H + 'px');
    root.style.setProperty('--book-w', BOOK_W + 'px');
    root.style.setProperty('--content-w', CONTENT_W + 'px');
  }

  function getImageSize(url){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>resolve({ w: img.naturalWidth, h: img.naturalHeight });
      img.onerror = ()=>reject(new Error('이미지 로드 실패: ' + url));
      img.src = url;
    });
  }

  // ===== Panzoom 세팅/리셋 =====
  function computeFit() {
    const vw = viewer.clientWidth, vh = viewer.clientHeight;

    // 1) 높이에 우선 맞춤
    let startScale = Math.min(vh / PAGE_H, 1);

    // 2) 그 결과 가로가 넘치면 contain으로 보정
    if (CONTENT_W * startScale > vw) {
      startScale = Math.min(vw / CONTENT_W, 1);
    }

    const startX = Math.round((vw - CONTENT_W * startScale) / 2);
    const startY = Math.round((vh - PAGE_H     * startScale) / 2);
    return { startScale, startX, startY };
  }

  function setupPanzoom(recreate=true){
    const { startScale, startX, startY } = computeFit();

    if (recreate && pz){
      pz.destroy();
      pz = null;
    }
    if (!pz){
      pz = Panzoom(zoomLayer, {
        startScale, startX, startY,
        minScale: MIN_SCALE, maxScale: MAX_SCALE,
        canvas: true,
        contain: 'outside',
        panOnlyWhenZoomed: true,
        touchAction: 'none',
        cursor: 'grab'
      });

      // 휠 줌: 트랙패드/마우스 모두 부드럽게, 줌아웃 충분히 되도록
      const onWheel = (e)=>{
        e.preventDefault();
        const { clientX:cx, clientY:cy, deltaY, deltaMode, ctrlKey } = e;
        const dy = deltaMode === 1 ? deltaY * 16 : deltaY; // line → px
        const base = ctrlKey ? 180 : 300;                  // Ctrl+휠(핀치) 더 민감
        const factor = Math.exp(-dy / base);               // dy>0 축소
        const target = Math.min(MAX_SCALE, Math.max(MIN_SCALE, pz.getScale() * factor));
        pz.zoomToPoint(target, { clientX: cx, clientY: cy }, { animate:false });
      };
      viewer.addEventListener('wheel', onWheel, { passive:false, capture:true });

      // 더블클릭/더블탭: 확대/축소 토글(선택)
      let lastClick = 0;
      viewer.addEventListener('pointerup', (e)=>{
        const now = performance.now();
        if (now - lastClick < 250){
          e.preventDefault();
          const r = viewer.getBoundingClientRect();
          const cx = e.clientX, cy = e.clientY;
          const s = pz.getScale();
          const target = s > 1 ? Math.max(MIN_SCALE, computeFit().startScale) : Math.min(1.8, s*2);
          pz.zoomToPoint(target, { clientX: cx, clientY: cy }, { animate:false });
        }
        lastClick = now;
      }, { capture:true });

      // 초기 프레임 뒤 한 번 더 정확히 맞춤
      requestAnimationFrame(()=> pz.reset({ startX, startY, startScale, animate:false }));
    } else {
      pz.reset({ startX, startY, startScale, animate:false });
    }
  }

  // viewer와 flipRoot 크기 변화를 모두 관찰해 즉시 재맞춤
  const roViewer = new ResizeObserver(()=> requestAnimationFrame(()=> setupPanzoom(false)));
  const roFlip   = new ResizeObserver(()=> requestAnimationFrame(()=> setupPanzoom(false)));
  roViewer.observe(viewer);
  roFlip.observe(flipRoot);

  // ===== PageFlip =====
  function initFlip(imageURLs, forcePortrait){
    flipRoot.innerHTML = '';
    if (pageFlip){ pageFlip.destroy(); pageFlip = null; }
    const portrait = !!forcePortrait;
    pageFlip = new St.PageFlip(flipRoot, {
      width: PAGE_W, height: PAGE_H,
      size: "fixed",
      minWidth: PAGE_W, maxWidth: PAGE_W,
      minHeight: PAGE_H, maxHeight: PAGE_H,
      usePortrait: portrait,
      showCover: portrait ? false : true, // 데스크톱: 표지 단면 → 이후 스프레드
      maxShadowOpacity: .2,
      mobileScrollSupport: false,
      disableFlipByClick: true
    });
    pageFlip.loadFromImages(imageURLs);
    totalEl.textContent = `/ ${imageURLs.length}`;
    pageInput.min = 1; pageInput.max = imageURLs.length; pageInput.value = 1;
    pageFlip.on('flip', e => { pageInput.value = e.data + 1; });
  }

  function goPrev(){ if(!pageFlip) return; pageFlip.flipPrev(); }
  function goNext(){ if(!pageFlip) return; pageFlip.flipNext(); }

  // ===== manifest =====
  async function fetchManifest(url){
    setStatus(`Fetching manifest: ${url}`);
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok){ const msg = `HTTP ${res.status} ${res.statusText} (manifest)\nURL: ${res.url}`; setStatus(msg); throw new Error(msg); }
    try { return await res.json(); } catch(e){ setStatus('manifest JSON 파싱 실패'); throw e; }
  }
  function normalizeManifest(manifest, manifestUrl){
    if (Array.isArray(manifest)) {
      const pages = [...manifest].sort(naturalSort).map(p => toAbs(p, manifestUrl));
      return { title: 'Monthly Art – Flipbook', pages };
    }
    if (manifest && Array.isArray(manifest.pages)) {
      const base = manifest.base ? toAbs(manifest.base, manifestUrl) : manifestUrl;
      const pages = manifest.pages.map(p => toAbs(p, base)).sort(naturalSort);
      return { title: manifest.title || 'Monthly Art – Flipbook', pages };
    }
    throw new Error('지원하지 않는 manifest 형식입니다.');
  }

  // ===== 모드 전환 =====
  function computeSinglePageMode(){ return window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`).matches; }
  function applyModeInit(){
    const single = computeSinglePageMode();
    isSinglePageMode = single;
    CONTENT_W = isSinglePageMode ? PAGE_W : BOOK_W;
    applyCSSVars();
    initFlip(currentPages, isSinglePageMode);
    setupPanzoom(true);
    setStatus('Ready');
  }
  function applyModeOnResize(){
    const nextSingle = computeSinglePageMode();
    const keepIndex = pageFlip ? pageFlip.getCurrentPageIndex() : 0;
    if (nextSingle !== isSinglePageMode){
      isSinglePageMode = nextSingle;
      CONTENT_W = isSinglePageMode ? PAGE_W : BOOK_W;
      applyCSSVars();
      initFlip(currentPages, isSinglePageMode);
      pageFlip.flip(keepIndex); // 인덱스 복구
    } else {
      CONTENT_W = isSinglePageMode ? PAGE_W : BOOK_W;
      applyCSSVars();
    }
    setupPanzoom(true);
  }

  // ===== 컨트롤 =====
  prevBtn.addEventListener('click', goPrev);
  nextBtn.addEventListener('click', goNext);
  pageInput.addEventListener('change', ()=>{
    if(!pageFlip) return;
    const n = Math.max(1, Math.min(parseInt(pageInput.value||'1',10), pageFlip.getPageCount()));
    pageFlip.flip(n-1); pageInput.value = n;
  });
  fsBtn.addEventListener('click', ()=>{
    const el = viewer;
    if(!document.fullscreenElement){
      (el.requestFullscreen || el.webkitRequestFullscreen || document.documentElement.requestFullscreen).call(el);
    } else {
      (document.exitFullscreen || document.webkitExitFullscreen || document.cancelFullscreen).call(document);
    }
  });

  // 가장자리 탭으로만 페이지 넘김 (배율 ≤ 1)
  viewer.addEventListener('pointerdown', (e)=>{
    tapStart = { x:e.clientX, y:e.clientY, t:performance.now() };
  }, { capture:true });
  viewer.addEventListener('pointerup', (e)=>{
    if (!tapStart || !pageFlip || !pz) return;
    const moved = Math.hypot(e.clientX - tapStart.x, e.clientY - tapStart.y);
    const dt = performance.now() - tapStart.t;
    tapStart = null;
    if (pz.getScale() > 1) return; // 확대 중엔 페이징 금지
    if (moved <= TAP_MAX_DIST && dt <= TAP_MAX_MS){
      const r = flipRoot.getBoundingClientRect();
      if (e.clientY >= r.top && e.clientY <= r.bottom){
        const xRel = (e.clientX - r.left) / r.width;
        if (xRel <= EDGE_TAP_ZONE)       goPrev();
        else if (xRel >= 1-EDGE_TAP_ZONE) goNext();
      }
    }
  }, { capture:true });

  // 키보드: 확대 시 패닝 / 100% 이하는 페이징
  const PAN_STEP_PX = 120;
  window.addEventListener('keydown', (e)=>{
    if (isTextInputFocused()) return;
    const k = e.key;
    if (!['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(k)) return;
    e.preventDefault();
    if (pz && pz.getScale() > 1){
      const step = PAN_STEP_PX / pz.getScale();
      const pan = pz.getPan ? pz.getPan() : { x:0, y:0 };
      let nx = pan.x, ny = pan.y;
      if (k === 'ArrowLeft')  nx += step;
      if (k === 'ArrowRight') nx -= step;
      if (k === 'ArrowUp')    ny += step;
      if (k === 'ArrowDown')  ny -= step;
      pz.pan(nx, ny, { animate:false });
      return;
    }
    if (k === 'ArrowLeft')  goPrev();
    if (k === 'ArrowRight') goNext();
  });

  // 초기 로드
  (async ()=>{
    try{
      const absManifestUrl = toAbs(manifestArg, location.href);
      const raw = await fetchManifest(absManifestUrl);
      const normalized = normalizeManifest(raw, absManifestUrl);

      bookTitleEl.textContent = normalized.title || 'Monthly Art – Flipbook';
      currentPages = normalized.pages;
      if (!currentPages.length){ setStatus('manifest에 페이지가 없습니다.'); return; }

      // 첫 이미지 크기 → 페이지 크기 결정
      const dim = await getImageSize(currentPages[0]);
      PAGE_W = dim.w; PAGE_H = dim.h; BOOK_W = PAGE_W * 2; CONTENT_W = BOOK_W;
      applyCSSVars();

      applyModeInit();
    }catch(e){
      console.error(e);
      setStatus('로드 오류: ' + (e.message || e));
    }
  })();

  // 우클릭 방지
  document.addEventListener('contextmenu', (e)=>{ e.preventDefault(); }, { capture:true });

  // 윈도우 리사이즈(브레이크포인트 전환용)
  let _resizeTimer = null;
  window.addEventListener('resize', ()=>{
    clearTimeout(_resizeTimer);
    _resizeTimer = setTimeout(applyModeOnResize, 120);
  });
</script>
</body>
</html>
